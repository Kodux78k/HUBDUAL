<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>DUAL.app ‚Äî Splash ‚ñ∂ Hub de Apps</title>
<style>
  :root{
    /* tempo e cores base */
    --fade:.5s; --ink:#eaf1ff; --overlay:rgba(6,12,18,.55);

    /* Nebula Pro (coerente com index-splash.html) */
    --nebula-a:#0b1020; --nebula-b:#0d1a2b; --nebula-c:#0e2640; --nebula-d:#111a2a;
    --nebula-acc-1:#2a0b3a;  /* violeta */
    --nebula-acc-2:#003a49;  /* ciano escuro */

    /* Glass UI */
    --glass-bg: rgba(255,255,255,.06);
    --glass-stroke: rgba(255,255,255,.18);
    --shadow-soft: 0 10px 40px rgba(0,0,0,.45);
    --radius-2xl: 22px;

    --txt:#eaf5ff; --txt-dim:#b9c7d9; --txt-opp:#0a0f16;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink); background:#070b12; overflow:hidden;
    font:500 16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  }

  /* ======== CAMADA SPLASH / TRANSI√á√ïES ======== */
  .stage{position:fixed; inset:0; display:grid; place-items:center; background:#070b12}
  .layer{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0; transition:opacity var(--fade) ease}
  .show{opacity:1}
  .poster{object-position:center}
  .scrim{position:absolute; inset:0; background:transparent; transition:background var(--fade) ease}
  .scrim.on{background:var(--overlay)}
  .hotspot--center{position:absolute; left:50%; top:55%; transform:translate(-50%,-50%); width:min(42vw,280px); height:min(42vw,280px); border-radius:50%; z-index:6; cursor:pointer}
  .hud{position:fixed; right:10px; bottom:10px; padding:6px 10px;border-radius:10px;font-size:12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1)}

  /* ======== HUB DE APPS ======== */
  .hub{position:fixed; inset:0; display:grid; grid-template-rows:auto 1fr auto; z-index:7; opacity:0; pointer-events:none; transition:opacity var(--fade) ease}
  .hub.on{opacity:1; pointer-events:auto}
  .hub-bg{
    position:absolute; inset:0; z-index:-1;
    background:
      radial-gradient(1200px 900px at 80% 10%, var(--nebula-acc-2) -10%, transparent 50%),
      radial-gradient(900px 700px at 15% 20%, var(--nebula-acc-1) -10%, transparent 55%),
      linear-gradient(160deg, var(--nebula-a), var(--nebula-b) 30%, var(--nebula-c) 65%, var(--nebula-d));
  }

  /* Header */
  .hub-head{display:flex; align-items:center; gap:12px; padding:12px 14px}
  .brand{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:16px; background:var(--glass-bg); border:1px solid var(--glass-stroke); backdrop-filter: blur(10px)}
  .brand .pill{width:22px; height:22px; border-radius:50%; background: radial-gradient(circle at 35% 35%, #fff 0 14%, rgba(255,255,255,.6) 22%, transparent 60%), radial-gradient(circle at 65% 70%, #0bd0ff, #0aa4ff 60%, transparent 75%), radial-gradient(circle at 20% 80%, #ff8a1f, transparent 60%); box-shadow: 0 0 18px rgba(11,208,255,.45), 0 0 12px rgba(255,106,47,.25)}
  .brand h1{margin:0; font-size:16px; font-weight:800; letter-spacing:.3px}
  .spacer{flex:1}

  /* Brain (SK + modelo) */
  .brain{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .field{display:flex; align-items:center; gap:8px; background:var(--glass-bg); border:1px solid var(--glass-stroke); border-radius:14px; padding:8px 10px}
  .field input,.field select{background:transparent; border:0; color:var(--txt); outline:0; font:600 14px/1.2 inherit; min-width:0}
  .field input::placeholder{color:var(--txt-dim)}
  .btn{appearance:none; cursor:pointer; border:1px solid var(--glass-stroke); background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.04)); color:var(--txt); padding:9px 12px; border-radius:14px; font-weight:700; box-shadow:var(--shadow-soft)}

  /* Body: coluna esquerda (launcher) + √°rea de janelas */
  .hub-body{display:grid; grid-template-columns: 108px 1fr; gap:12px; padding:8px 14px 14px}
  .dock{display:flex; flex-direction:column; gap:10px}
  .card{display:flex; flex-direction:column; align-items:center; gap:8px; padding:10px; border-radius:18px; background:var(--glass-bg); border:1px solid var(--glass-stroke); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px)}
  .card .icon{width:42px; height:42px; border-radius:12px; background: linear-gradient(135deg, rgba(11,208,255,.25), rgba(255,106,47,.18)); display:grid; place-items:center}
  .card .label{font:700 12px/1.15 Inter, ui-sans-serif; color:var(--txt)}

  /* √Årea de janelas */
  .windows{position:relative; min-height:58vh; border-radius:18px; background:rgba(255,255,255,.03); border:1px solid var(--glass-stroke); overflow:hidden}
  .win{position:absolute; inset:0; display:grid; grid-template-rows:auto 1fr; border-left:1px solid rgba(255,255,255,.06); background:rgba(7,11,18,.72)}
  .win-head{display:flex; align-items:center; gap:8px; padding:8px 10px; background:rgba(255,255,255,.06); border-bottom:1px solid rgba(255,255,255,.12)}
  .win-title{font-weight:800; font-size:13px; color:var(--txt)}
  .win-actions{margin-left:auto; display:flex; gap:6px}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--glass-bg); border:1px solid var(--glass-stroke); font:700 11px/1 Inter}
  .chip b{opacity:.9}
  .win-body{position:relative}
  .win iframe{position:absolute; inset:0; width:100%; height:100%; border:0; background:#0a0f16}
  .mini{display:flex; flex-wrap:wrap; gap:8px; padding:10px}
  .mini .badge{padding:7px 10px; background:var(--glass-bg); border:1px solid var(--glass-stroke); border-radius:999px; font:700 11px/1 Inter; cursor:pointer}

  /* Footer */
  .hub-foot{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 14px}
  .hint{ color:var(--txt-dim); font-size: 12px; opacity:.9 }

  /* Upload field looks like a card */
  .upload{display:flex; flex-direction:column; gap:10px; padding:10px; border-radius:18px; background:var(--glass-bg); border:1px solid var(--glass-stroke)}
  .upload input[type=file]{display:none}
  .upload .label-btn{display:inline-flex; align-items:center; gap:10px; font-weight:800; cursor:pointer}

  @media (max-width: 760px){
    .hub-body{grid-template-columns: 1fr;}
    .dock{flex-direction:row; overflow:auto; padding-bottom:6px}
    .windows{min-height:55vh}
  }
</style>
</head>
<body>
<main class="stage" id="stage" aria-hidden="false">
  <!-- ========== 1) SPLASH / IDLE / TRANSI√á√ÉO (mesma pilha do seu index.html) ========== -->
  <video id="vSplash" class="layer" playsinline muted preload="auto">
    <source src="./assets/animations/animado/hub_splash.mp4"  type="video/mp4"/>
    <source src="./assets/animations/animado/hub_splash.webm" type="video/webm"/>
    <source src="./assets/animations/animado/hub_splash.mov"  type="video/quicktime"/>
  </video>
  <img id="gSplash" class="layer poster" src="/assets/animations/animado/hub_splash.gif" alt="Splash GIF"/>
  <img id="iSplash" class="layer poster" src="/assets/animations/animado/hub_splash.png" alt="Splash PNG"/>

  <video id="vIdle" class="layer" playsinline muted preload="auto">
    <source src="./assets/animations/animado/hub_home_loop.mp4"  type="video/mp4"/>
    <source src="./assets/animations/animado/hub_home_loop.webm" type="video/webm"/>
    <source src="./assets/animations/animado/hub_home_loop.mov"  type="video/quicktime"/>
  </video>
  <img id="gIdle" class="layer poster" src="/assets/animations/animado/hub_home_loop.gif" alt="Idle GIF"/>

  <video id="vTrans" class="layer" playsinline muted preload="auto">
    <source src="./assets/animations/animado/hub_trans_home.mp4"  type="video/mp4"/>
    <source src="./assets/animations/animado/hub_trans_home.webm" type="video/webm"/>
    <source src="./assets/animations/animado/hub_trans_home.mov"  type="video/quicktime"/>
  </video>

  <img id="iPill" class="layer poster" src="/assets/animations/animado/hub_pill_home.png" alt="P√≠lula Home"/>
  <video id="vHub" class="layer" playsinline muted preload="auto" loop>
    <source src="./assets/animations/animado/hub_home_loop.mp4"  type="video/mp4"/>
    <source src="./assets/animations/animado/hub_home_loop.webm" type="video/webm"/>
    <source src="./assets/animations/animado/hub_home_loop.mov"  type="video/quicktime"/>
  </video>
  <img id="gHub" class="layer poster" src="./assets/animations/animado/hub_home_loop.gif" alt="Hub GIF"/>
  <img id="iHub" class="layer poster" src="./assets/animations/animado/hub_home_static.png" alt="Hub Est√°tico"/>

  <div class="scrim" id="scrim"></div>
  <a id="hotspotCenter" class="hotspot--center" aria-label="Entrar"></a>
  <div class="hud" id="hud">‚Ä¶</div>
</main>

<!-- ========== 2) HUB DE APPS (fica oculto at√© a transi√ß√£o terminar) ========== -->
<section class="hub" id="hub" aria-hidden="true">
  <div class="hub-bg"></div>
  <header class="hub-head">
    <div class="brand"><div class="pill"></div><h1>Dual ‚Ä¢ Hub de Apps</h1></div>
    <div class="spacer"></div>
    <div class="brain" id="brain">
      <div class="field"><label for="sk" class="hint">SK</label><input id="sk" type="password" placeholder="sk-‚Ä¶" autocomplete="off"></div>
      <div class="field">
        <label for="model" class="hint">Modelo</label>
        <select id="model">
          <option value="psique" selected>psique</option>
          <option value="lama">lama</option>
          <option value="hermes">hermes</option>
          <option value="atlas">atlas</option>
          <option value="nova">nova</option>
          <option value="elysha">elysha</option>
        </select>
      </div>
      <button class="btn" id="saveBrain">Salvar</button>
    </div>
  </header>

  <div class="hub-body">
    <!-- Launcher / Dock -->
    <aside class="dock">
      <div class="upload card">
        <label class="label-btn" for="upHtml">‚ûï Carregar HTML</label>
        <input id="upHtml" type="file" accept=".html,.htm" />
        <small class="hint">Seu arquivo roda em sandbox seguro</small>
      </div>
      <div id="appList" class="card">
        <div class="icon">üì¶</div>
        <div class="label">Seus Apps</div>
        <div class="mini" id="mini"></div>
      </div>
    </aside>

    <!-- √Årea de Janelas / IFrames -->
    <section class="windows" id="windows">
      <!-- janelas din√¢micas ser√£o injetadas aqui -->
    </section>
  </div>

  <footer class="hub-foot">
    <span class="hint">Sandbox: <code>iframe[sandbox="allow-scripts allow-forms allow-modals"]</code></span>
    <div class="hint">Persist√™ncia: <code>localStorage.dualApps</code> & <code>localStorage.dualBrain</code></div>
  </footer>
</section>

<script>
/*******************
 *  ESTADO GLOBAL  *
 *******************/
const T = { splashMax:3500, idleHub:9000, idlePoster:6000, trans:1360 };
const $ = (q,el=document)=>el.querySelector(q);
const hud = $('#hud'), scrim = $('#scrim');
const vSplash = $('#vSplash'), gSplash=$('#gSplash'), iSplash=$('#iSplash');
const vIdle   = $('#vIdle'),   gIdle=$('#gIdle');
const vTrans  = $('#vTrans');
const iPill   = $('#iPill');
const vHub    = $('#vHub'),   gHub=$('#gHub'), iHub=$('#iHub');
const hotspotCenter = $('#hotspotCenter');

const hub = $('#hub');
const windows = $('#windows');
const mini = $('#mini');
const upHtml = $('#upHtml');
const saveBrainBtn = $('#saveBrain');
const skInput = $('#sk');
const modelSel = $('#model');

let state='boot', timers=[];
const log = m => hud.textContent = `state: ${state} | ${m}`;
const delay = ms => new Promise(r=> timers.push(setTimeout(r,ms)));
const clearTimers = ()=> { timers.forEach(clearTimeout); timers=[]; };
const show = el => el.classList.add('show');
const hide = el => el.classList.remove('show');
const whenCanPlay = v => new Promise(res=>{ if(!v) return res(); if(v.readyState>=2) return res(); v.addEventListener('canplay',()=>res(),{once:true}); });
const safePlay = v => v?.play?.().catch(()=>{});

function showChain(video, gif, poster){
  hide(video); hide(gif); if(poster) hide(poster);
  if (video && video.readyState>=2){ show(video); return 'video'; }
  if (gif && gif.complete){ show(gif); return 'gif'; }
  if (poster){ show(poster); return 'poster'; }
  return 'none';
}

/*******************
 *  C√âREBRO (SK/MODEL)
 *******************/
const Brain = {
  key:'dualBrain',
  get(){ try{ return JSON.parse(localStorage.getItem(this.key)||'{}'); }catch{ return {}; } },
  set(data){ localStorage.setItem(this.key, JSON.stringify(data)); }
};
function loadBrain(){ const b=Brain.get(); if(b.sk) skInput.value=b.sk; if(b.model) modelSel.value=b.model; }
function saveBrain(){ Brain.set({ sk: skInput.value.trim(), model: modelSel.value }); toast('Prefer√™ncias salvas'); }

/*******************
 *  APPS (UPLOAD / LISTA / JANELAS)
 *******************/
const Apps = {
  key:'dualApps',
  list:[],
  load(){ try{ this.list = JSON.parse(localStorage.getItem(this.key)||'[]'); }catch{ this.list=[]; } },
  save(){ localStorage.setItem(this.key, JSON.stringify(this.list)); },
  add(name, html){ const id = Date.now().toString(36)+Math.random().toString(36).slice(2,7); const app={id,name,html, minimized:false, ts:Date.now()}; this.list.push(app); this.save(); return app; },
  get(id){ return this.list.find(a=>a.id===id); },
  remove(id){ this.list = this.list.filter(a=>a.id!==id); this.save(); }
};

function renderMini(){
  mini.innerHTML = '';
  if(!Apps.list.length){ const span=document.createElement('span'); span.className='hint'; span.textContent='Nenhum app ainda'; mini.appendChild(span); return; }
  Apps.list.slice().sort((a,b)=>b.ts-a.ts).forEach(app=>{
    const b=document.createElement('button'); b.className='badge'; b.textContent=truncate(app.name, 18);
    b.title=app.name; b.onclick=()=> openWindow(app.id);
    mini.appendChild(b);
  });
}

function truncate(str,n){ return (str.length>n)? str.slice(0,n-1)+'‚Ä¶' : str; }

function openWindow(appId){
  const app = Apps.get(appId); if(!app) return;
  // fecha janelas anteriores (comportamento single-view; altere conforme preferir)
  windows.querySelectorAll('.win').forEach(w=>w.remove());

  const win = document.createElement('section'); win.className='win'; win.dataset.id = appId;
  const head = document.createElement('div'); head.className='win-head';
  const title = document.createElement('div'); title.className='win-title'; title.textContent = app.name;
  const chips = document.createElement('div'); chips.className='chip'; chips.innerHTML = `<b>Modelo</b>: <span id="chipModel">${modelSel.value}</span>`;

  const actions = document.createElement('div'); actions.className='win-actions';
  const bMin = btnIcon('min','Min');
  const bRes = btnIcon('res','Rest'); bRes.style.display='none';
  const bNew = btnIcon('new','Nova Aba');
  const bDel = btnIcon('del','Fechar');

  head.append(title, chips, actions);
  actions.append(bMin, bRes, bNew, bDel);

  const body = document.createElement('div'); body.className='win-body';
  const iframe = document.createElement('iframe');
  iframe.setAttribute('sandbox','allow-scripts allow-forms allow-modals');
  iframe.setAttribute('referrerpolicy','no-referrer');
  iframe.srcdoc = injectEnv(app.html);
  body.appendChild(iframe);

  win.append(head, body);
  windows.appendChild(win);

  // A√á√ïES
  bMin.onclick = ()=>{ body.style.display='none'; bMin.style.display='none'; bRes.style.display='inline-flex'; };
  bRes.onclick = ()=>{ body.style.display=''; bRes.style.display='none'; bMin.style.display='inline-flex'; };
  bNew.onclick = ()=>{
    const w = window.open('about:blank','_blank','noopener,noreferrer');
    if(w){ w.document.open(); w.document.write(app.html); w.document.close(); }
  };
  bDel.onclick = ()=>{ win.remove(); };
}

function btnIcon(kind,label){
  const b=document.createElement('button'); b.className='btn'; b.title=label;
  b.textContent = kind==='min'?'‚Äî': kind==='res'?'‚ñ¢': kind==='new'?'‚ßâ':'‚úï';
  return b;
}

function injectEnv(html){
  // Injeta vari√°veis de ambiente (SK/Model) em window.__DUAL__ para o app usar se quiser
  const env = `<script>window.__DUAL__={sk:${JSON.stringify(skInput.value)}, model:${JSON.stringify(modelSel.value)}}<\/script>`;
  // Insere antes de </head> se existir; caso contr√°rio, prefixa
  if(/<\/head>/i.test(html)) return html.replace(/<\/head>/i, env + '\n</head>');
  return env + html;
}

/*******************
 *  UPLOAD
 *******************/
upHtml.addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0]; if(!file) return;
  const text = await file.text();
  const app = Apps.add(file.name, text);
  renderMini();
  openWindow(app.id);
  upHtml.value='';
});

/*******************
 *  BOOT SPLASH ‚Üí HUB
 *******************/
(async function start(){
  // limpar/padr√£o
  state='splash'; await whenCanPlay(vSplash);
  vSplash.currentTime=0; show(vSplash); log('splash ‚ñ∂'); safePlay(vSplash);
  await Promise.race([ delay(T.splashMax), new Promise(r=> vSplash.addEventListener('ended', r, {once:true})) ]);
  hide(vSplash);
  state='idle'; log('idle loop iniciado'); idleCycleLoop().catch(()=>{});
})();

async function idleCycleLoop(){
  while(state==='idle'){
    await whenCanPlay(vIdle);
    showChain(vIdle, gIdle, null);
    if (vIdle.readyState>=2){ vIdle.currentTime=0; safePlay(vIdle); }
    log('idle hub ‚ñ∂ 9s'); await delay(T.idleHub);
    hide(vIdle); hide(gIdle);
    show(iSplash); log('idle poster ‚è∏ 6s'); await delay(T.idlePoster); hide(iSplash);
  }
}

async function onEnter(){
  if(state==='transition' || state==='hub-final') return;
  clearTimers(); state='transition'; scrim.classList.add('on');
  hide(vSplash); hide(gSplash); hide(iSplash); hide(vIdle); hide(gIdle);
  await whenCanPlay(vTrans); vTrans.currentTime=0; show(vTrans); safePlay(vTrans); log('transi√ß√£o ‚ñ∂');
  await Promise.race([ delay(T.trans+80), new Promise(r=> vTrans.addEventListener('ended', r, {once:true})) ]);
  hide(vTrans);
  show(iPill); log('p√≠lula'); await delay(140); hide(iPill);
  await whenCanPlay(vHub); showChain(vHub, gHub, iHub); if (vHub.readyState>=2){ vHub.currentTime=0; safePlay(vHub); }
  scrim.classList.remove('on'); state='hub-final'; log('hub final ‚ñ∂');
  // === MOSTRA O HUB DE APPS ===
  hub.classList.add('on'); hub.setAttribute('aria-hidden','false');
  // carrega persist√™ncia
  loadBrain(); Apps.load(); renderMini();
}

['click','touchstart'].forEach(ev=> hotspotCenter.addEventListener(ev, onEnter, {passive:true}));
hotspotCenter.tabIndex=0; hotspotCenter.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); onEnter(); }});

/*******************
 *  UTILIDADE: Toast simples
 *******************/
let toastTm;
function toast(msg){
  clearTimeout(toastTm);
  const t = document.createElement('div');
  t.textContent = msg; t.style.cssText = 'position:fixed;left:50%;bottom:20px;transform:translateX(-50%);padding:10px 14px;border-radius:12px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);backdrop-filter:blur(8px);font-weight:800;z-index:9999';
  document.body.appendChild(t);
  toastTm = setTimeout(()=>{ t.remove(); }, 1600);
}

saveBrainBtn.addEventListener('click', saveBrain);

/*******************
 *  PWA: Service Worker (se existir)
 *******************/
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js').catch(err => console.warn('SW reg failed', err));
  });
}
</script>
</body>
</html>
