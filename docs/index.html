<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>DUAL.app — Splash ▶ Idle ▶ Hub</title>
<style>
  :root{ --fade:.5s; --ink:#eaf1ff; --overlay:rgba(6,12,18,.55); }
  html,body{height:100%;margin:0}
  body{
    background:#070b12; color:var(--ink);
    font:500 16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    overflow:hidden;
  }
  .stage{position:fixed; inset:0; display:grid; place-items:center; background:#070b12}
  .layer{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0; transition:opacity var(--fade) ease}
  .show{opacity:1}
  .poster{object-position:center}
  .scrim{position:absolute; inset:0; background:transparent; transition:background var(--fade) ease}
  .scrim.on{background:var(--overlay)}

  /* hotspot circular central (grande pra não errar) */
  .hotspot--center{
    position:absolute; left:50%; top:55%; transform:translate(-50%,-50%);
    width:min(42vw, 280px); height:min(42vw, 280px);
    border-radius:50%; z-index:6; cursor:pointer;
    /* debug:
    outline:1px dashed rgba(255,255,255,.35);
    background:rgba(255,255,255,.06); */
  }

  .hud{
    position:fixed; right:10px; bottom:10px; padding:6px 10px;border-radius:10px;font-size:12px;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1)
  }
</style>

  <!-- Progressive Web App (PWA) metadata -->
  <!-- Manifest file describing icons, colours and behaviour of the app when installed -->
  <link rel="manifest" href="/manifest.webmanifest">
  <!-- Primary theme colour for the address bar and system UI -->
  <meta name="theme-color" content="#0a0f16">
  <!-- Enable standalone mode on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Fallback icon for iOS home screen -->
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
</head>
<body>
<main class="stage" id="stage">

  <!-- 1) SPLASH (~3.5s, sem loop) -->
  <video id="vSplash" class="layer" playsinline muted preload="auto">
    <source src="/assets/animations/animado/hub_splash.mp4"  type="video/mp4"/>
    <source src="/assets/animations/animado/hub_splash.webm" type="video/webm"/>
    <source src="/assets/animations/animado/hub_splash.mov"  type="video/quicktime"/>
  </video>
  <img id="gSplash" class="layer poster" src="/assets/animations/animado/hub_splash.gif" alt="Splash GIF"/>
  <!-- Poster estático do splash em PNG -->
  <img id="iSplash" class="layer poster" src="/assets/animations/animado/hub_splash.png" alt="Splash PNG"/>

  <!-- 2) IDLE: HUB LOOP (9s) — vai alternando com poster do splash -->
  <video id="vIdle" class="layer" playsinline muted preload="auto">
    <source src="/assets/animations/animado/hub_home_loop.mp4"  type="video/mp4"/>
    <source src="/assets/animations/animado/hub_home_loop.webm" type="video/webm"/>
    <source src="/assets/animations/animado/hub_home_loop.mov"  type="video/quicktime"/>
  </video>
  <img id="gIdle" class="layer poster" src="/assets/animations/animado/hub_home_loop.gif" alt="Idle GIF"/>
  <!-- usamos a MESMA imagem do splash para o “descanso” entre loops -->
  <!-- iSplash já está definido acima e será reutilizado -->

  <!-- 3) TRANSIÇÃO (1.36s) -->
  <video id="vTrans" class="layer" playsinline muted preload="auto">
    <source src="/assets/animations/animado/hub_trans_home.mp4"  type="video/mp4"/>
    <source src="/assets/animations/animado/hub_trans_home.webm" type="video/webm"/>
    <source src="/assets/animations/animado/hub_trans_home.mov"  type="video/quicktime"/>
  </video>

  <!-- 4) PÍLULA + HUB LOOP (9s loop final, com fallback) -->
  <!-- Poster estático da pílula em PNG -->
  <img id="iPill" class="layer poster" src="/assets/animations/animado/hub_pill_home.png" alt="Pílula Home"/>
  <video id="vHub" class="layer" playsinline muted preload="auto" loop>
    <source src="/assets/animations/animado/hub_home_loop.mp4"  type="video/mp4"/>
    <source src="/assets/animations/animado/hub_home_loop.webm" type="video/webm"/>
    <source src="/assets/animations/animado/hub_home_loop.mov"  type="video/quicktime"/>
  </video>
  <img id="gHub" class="layer poster" src="/assets/animations/animado/hub_home_loop.gif" alt="Hub GIF"/>
  <!-- Poster estático do hub em PNG -->
  <img id="iHub" class="layer poster" src="/assets/animations/animado/hub_home_static.png" alt="Hub Estático"/>

  <!-- Fade/Blend -->
  <div class="scrim" id="scrim"></div>

  <!-- Hotspot circular no centro -->
  <a id="hotspotCenter" class="hotspot--center" aria-label="Entrar"></a>

  <div class="hud" id="hud">…</div>
</main>

<script>
/* tempos (ms) */
const T = {
  splashMax: 3500,     // ~3.5s
  idleHub:   9000,     // 9s vídeo do hub (espera)
  idlePoster:6000,     // 6s imagem do splash entre loops
  trans:     1360      // 1.36s transição
};

const $ = (q,el=document)=>el.querySelector(q);
const hud = $('#hud');
const scrim = $('#scrim');

const vSplash = $('#vSplash'), gSplash = $('#gSplash'), iSplash = $('#iSplash');
const vIdle   = $('#vIdle'),   gIdle   = $('#gIdle'); // iSplash será o poster da pausa
const vTrans  = $('#vTrans');
const iPill   = $('#iPill');
const vHub    = $('#vHub'),   gHub    = $('#gHub'),  iHub = $('#iHub');

const hotspotCenter = $('#hotspotCenter');

let state='boot', timers=[];
const log = m => hud.textContent = `state: ${state} | ${m}`;
const delay = ms => new Promise(r=> timers.push(setTimeout(r,ms)));
const clearTimers = ()=> { timers.forEach(clearTimeout); timers=[]; };
const show = el => el.classList.add('show');
const hide = el => el.classList.remove('show');
const whenCanPlay = v => new Promise(res=>{
  if(!v) return res(); if(v.readyState>=2) return res();
  v.addEventListener('canplay',()=>res(),{once:true});
});
const safePlay = v => v?.play?.().catch(()=>{});

/* vídeo → gif → (quando usamos poster, é o iSplash ou iHub) */
function showChain(video, gif, poster){
  hide(video); hide(gif); if(poster) hide(poster);
  if (video && video.readyState>=2) { show(video); return 'video'; }
  if (gif && gif.complete) { show(gif); return 'gif'; }
  if (poster) { show(poster); return 'poster'; }
  return 'none';
}

/* fluxo */
(async function start(){
  /* SPLASH */
  state='splash'; await whenCanPlay(vSplash);
  vSplash.currentTime=0; show(vSplash); log('splash ▶'); safePlay(vSplash);

  await Promise.race([ delay(T.splashMax), new Promise(r=> vSplash.addEventListener('ended', r, {once:true})) ]);
  hide(vSplash);

  /* inicia ciclo de espera: hub loop (9s) ↔ poster do splash (6s) */
  state='idle'; log('idle loop iniciado');
  idleCycleLoop().catch(()=>{});
})();

/* ciclo infinito enquanto state === 'idle' */
async function idleCycleLoop(){
  while(state==='idle'){
    // toca o vídeo de espera (hub loop) por 9s
    await whenCanPlay(vIdle);
    showChain(vIdle, gIdle, null);
    if (vIdle.readyState>=2){ vIdle.currentTime=0; safePlay(vIdle); }
    log('idle hub ▶ 9s');
    await delay(T.idleHub);
    hide(vIdle); hide(gIdle);

    // pausa em poster do splash por 6s
    show(iSplash); log('idle poster ⏸ 6s');
    await delay(T.idlePoster);
    hide(iSplash);
  }
}

/* clique → executa transição para HUB definitivo */
async function onEnter(){
  if(state==='transition' || state==='hub-final') return;
  clearTimers();
  state='transition';
  scrim.classList.add('on');

  // limpa qualquer mídia anterior
  hide(vSplash); hide(gSplash); hide(iSplash);
  hide(vIdle);   hide(gIdle);

  // 1) transição
  await whenCanPlay(vTrans);
  vTrans.currentTime=0; show(vTrans); safePlay(vTrans); log('transição ▶');
  await Promise.race([ delay(T.trans+80), new Promise(r=> vTrans.addEventListener('ended', r, {once:true})) ]);
  hide(vTrans);

  // 2) pílula e hub final
  show(iPill); log('pílula');
  await delay(140);
  hide(iPill);

  // hub final com fallback
  await whenCanPlay(vHub);
  showChain(vHub, gHub, iHub);
  if (vHub.readyState>=2){ vHub.currentTime=0; safePlay(vHub); }
  scrim.classList.remove('on');
  state='hub-final'; log('hub final ▶');
}

/* eventos */
['click','touchstart'].forEach(ev=> hotspotCenter.addEventListener(ev, onEnter, {passive:true}));
hotspotCenter.tabIndex=0;
hotspotCenter.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); onEnter(); }});

/* (hooks PWA – envio em próximo passo)
<link rel="manifest" href="/manifest.webmanifest">
<script> if('serviceWorker' in navigator){ navigator.serviceWorker.register('/service-worker.js'); } </script>
*/
</script>
<!-- Register the service worker after the page has loaded -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .catch(err => console.warn('SW reg failed', err));
    });
  }
</script>
</body>
</html>